import React, { useState, useRef } from "react";
import GeneratedWords from "./components/GeneratedWords";
import RestartButton from "./components/RestartButton";
import TestResults from "./components/TestResults";
import TypedCharacters from "./components/TypedCharacters";
import useEngine from "./hooks/useEngine";
import UserPanel from "./components/UserPanel";
import { calculateAccuracyPercentage } from "./utils/helpers";
import { VscGithub } from "react-icons/vsc";
import Leaderboard from "./components/Leaderboard";

const App = () => {
  // defined in a parent so we can pass to useEngine
  const [userPanelOpened, setUserPanelOpened] = useState<boolean>(false);
  const [leaderboardOpened, setLeaderboardOpened] = useState<boolean>(false);
  const timer = 15;

  const wordsContainerRef = useRef(null);

  const { words, typed, timeLeft, errors, state, restart, totalTyped, wpm, isNewPB } =
    useEngine(userPanelOpened, leaderboardOpened, timer, wordsContainerRef);

  return (
    <>
      <div className="absolute w-[800px] flex justify-between items-start top-20">
        <LogoHeader className={""}/>
        <Leaderboard 
          setLeaderboardOpened={setLeaderboardOpened}
        />
        <UserPanel
          setUserPanelOpened={setUserPanelOpened}
          userPanelOpened={userPanelOpened}
        />
      </div>
      <CountdownTimer timeLeft={timeLeft} />
      <div tabIndex={-1} className="flex flex-col items-center space-y-4">
        <WordsContainer ref={wordsContainerRef}>
          <GeneratedWords key={words} words={words} />
          {/* User typed characters will be overlayed over the generated words; ensure same Tailwind properties */}
          <TypedCharacters
            className="absolute inset-0 break-words whitespace-pre-wrap"
            words={words}
            userInput={typed}
          />
        </WordsContainer>
        <RestartButton
          className="relative text-subColor top-5"
          onRestart={restart}
        />
      </div>
      <TestResults
        className="absolute bottom-15 left-1/2 transform -translate-x-1/2 w-full mt-10"
        state={state}
        errors={errors}
        accuracyPercentage={calculateAccuracyPercentage(errors, totalTyped)}
        wpm={wpm}
        isNewPB={isNewPB}
      />
      <footer className="absolute bottom-2 left-1/2 flex flex-col items-center justify-center transform -translate-x-1/2 space-y-4 text-subColor">
        <div className="relative bottom-4 text-xs">
          <ToolTip>tab</ToolTip> + <ToolTip>enter</ToolTip> - restart test
        </div>
        <a 
          href="https://github.com/skarokin/ref-type"
          tabIndex={-1}
        >
          <button 
            tabIndex={-1}
            className={"relative bottom-2 left-1/2 flex items-center justify-center transform -translate-x-1/2 text-subColor block rounded px-4 py-2 transition-colors duration-300 ease-in-out hover:text-mainColor"}
          >
            <VscGithub className={"mr-2"} /> 
            GitHub 
          </button>
        </a>
      </footer>
    </>
  );
};

const WordsContainer = React.forwardRef<HTMLDivElement, { children: React.ReactNode }>(
  ({ children }, ref) => {
    return (
      <div 
        ref={ref}
        tabIndex={0} 
        className="relative min-w-[800px] h-[150px] text-3xl max-w-xl leading-relaxed break-words mt-3 select-none"
      >
        {children}
      </div>
    );
  }
);

const CountdownTimer = ({ timeLeft }: { timeLeft: number }) => {
  return <h2 className="text-mainColor text-xl">Time: {timeLeft}</h2>;
};

const LogoHeader = ({ className }: { className: string }) => {
  return (
    <>  
      <svg width="100" height="47" viewBox="0 0 100 47" fill="none" xmlns="http:  //www.w3.org/2000/svg" className={className}>
      <path d="M12.5 4.70001H87.5C93.5406 4.70001 98.4375 9.60996 98.4375 15.6667V34.4667C98.4375 40.5234 93.5406 45.4333 87.5 45.4333H12.5C6.45939 45.4333 1.5625 40.5234 1.5625 34.4667V15.6667C1.5625 9.60996 6.45939 4.70001 12.5 4.70001Z" stroke="#ec4c56" stroke-width="2"/>
      <path d="M9.69063 15.604V18.6089H7V15.3847C7 15.0191 7.0875 14.712 7.2625 14.4635C7.4375 14.2003 7.68542 13.959 8.00625 13.7397C8.44375 13.4765 8.99792 13.2571 9.66875 13.0817C10.3396 12.9062 11.0615 12.8185 11.8344 12.8185C13.2052 12.8185 13.8906 13.2425 13.8906 14.0906C13.8906 14.2953 13.8615 14.4854 13.8031 14.6609C13.7448 14.8217 13.6719 14.9679 13.5844 15.0995C13.4385 15.0703 13.2563 15.0483 13.0375 15.0337C12.8188 15.0045 12.5854 14.9899 12.3375 14.9899C11.8125 14.9899 11.3167 15.0483 10.85 15.1653C10.3979 15.2677 10.0115 15.4139 9.69063 15.604ZM7 17.7096L9.69063 17.8412V23.4561C9.57397 23.5 9.40625 23.5365 9.1875 23.5658C8.96875 23.6097 8.72813 23.6316 8.46563 23.6316C7.9698 23.6316 7.59792 23.5439 7.35 23.3684C7.11667 23.1783 7 22.8493 7 22.3814V17.7096ZM17.649 19.6836L17.5396 17.7973L23.4021 16.92C23.3584 16.3643 23.147 15.8818 22.7677 15.4724C22.3887 15.063 21.8345 14.8583 21.1052 14.8583C20.3615 14.8583 19.7418 15.1215 19.2459 15.6479C18.7501 16.1597 18.4949 16.8981 18.4802 17.8631L18.5459 19.0037C18.6771 19.9394 19.0345 20.6267 19.6177 21.0654C20.2157 21.5041 20.9668 21.7234 21.8709 21.7234C22.4834 21.7234 23.0521 21.6357 23.5771 21.4602C24.1021 21.2701 24.5177 21.0654 24.824 20.8461C25.0282 20.9777 25.1887 21.1458 25.3052 21.3505C25.4365 21.5406 25.5021 21.7527 25.5021 21.9866C25.5021 22.3668 25.3345 22.6958 24.999 22.9736C24.6637 23.2368 24.2115 23.4415 23.6427 23.5877C23.074 23.7339 22.4251 23.8071 21.6959 23.8071C20.573 23.8071 19.574 23.6023 18.699 23.1929C17.8387 22.7688 17.1605 22.1401 16.6646 21.3067C16.1834 20.4732 15.9427 19.435 15.9427 18.1921C15.9427 17.3002 16.0813 16.5178 16.3584 15.8453C16.6355 15.1726 17.0074 14.617 17.474 14.1783C17.9552 13.725 18.5095 13.3887 19.1365 13.1694C19.7637 12.9354 20.4199 12.8185 21.1052 12.8185C22.0677 12.8185 22.9063 13.0159 23.6209 13.4107C24.3501 13.7908 24.9188 14.3245 25.3271 15.0118C25.7501 15.6991 25.9615 16.4887 25.9615 17.3806C25.9615 17.79 25.8521 18.097 25.6334 18.3018C25.4293 18.4918 25.1376 18.6089 24.7584 18.6527L17.649 19.6836ZM31.4348 15.9111V13.8055H35.8316C35.8899 13.9078 35.9482 14.054 36.0066 14.2441C36.0795 14.4196 36.116 14.6243 36.116 14.8583C36.116 15.2238 36.0285 15.4943 35.8535 15.6698C35.693 15.8307 35.4598 15.9111 35.1535 15.9111H31.4348ZM31.8504 12.7527V15.5821H29.2691V12.643C29.2691 11.7218 29.4513 10.9761 29.816 10.4058C30.1951 9.8209 30.7129 9.39685 31.3691 9.13365C32.0399 8.85583 32.7982 8.71692 33.6441 8.71692C34.592 8.71692 35.3138 8.8412 35.8098 9.08979C36.3055 9.33837 36.5535 9.71123 36.5535 10.2084C36.5535 10.4277 36.5024 10.6324 36.4004 10.8225C36.3129 10.998 36.2035 11.1442 36.0723 11.2612C35.7951 11.1442 35.4816 11.0492 35.1316 10.9761C34.7962 10.9029 34.4388 10.8664 34.0598 10.8664C33.2868 10.8664 32.7254 11.0126 32.3754 11.3051C32.0254 11.5975 31.8504 12.08 31.8504 12.7527ZM29.2691 14.8144H31.9598V23.4561C31.843 23.5 31.6754 23.5365 31.4566 23.5658C31.2379 23.6097 30.9973 23.6316 30.7348 23.6316C30.2388 23.6316 29.867 23.5439 29.6191 23.3684C29.3857 23.1783 29.2691 22.8493 29.2691 22.3814V14.8144Z" fill="#ec4c56"/>
      <path d="M48.2614 23.9763H50.952V26.5644C50.952 27.0469 51.0906 27.3905 51.3677 27.5953C51.6594 27.8 52.0677 27.9023 52.5927 27.9023C52.8261 27.9023 53.0739 27.873 53.3364 27.8146C53.6136 27.7562 53.8469 27.683 54.0364 27.5953C54.1386 27.7123 54.2333 27.8511 54.3208 28.012C54.4083 28.1729 54.452 28.3703 54.452 28.6042C54.452 29.0283 54.248 29.3792 53.8395 29.657C53.4458 29.9348 52.8261 30.0737 51.9802 30.0737C50.8281 30.0737 49.9167 29.8179 49.2458 29.3061C48.5895 28.7797 48.2614 27.9316 48.2614 26.7618V23.9763ZM49.902 21.7391V19.6115H54.1895C54.248 19.7138 54.3063 19.8602 54.3645 20.0502C54.4375 20.2402 54.4739 20.4376 54.4739 20.6424C54.4739 21.0079 54.3864 21.2858 54.2114 21.4759C54.0364 21.6513 53.8105 21.7391 53.5333 21.7391H49.902ZM50.952 24.5685H48.2614V16.6725C48.3781 16.6286 48.5458 16.5847 48.7645 16.5409C48.998 16.497 49.2386 16.4751 49.4864 16.4751C49.9969 16.4751 50.3688 16.5702 50.602 16.7602C50.8355 16.9357 50.952 17.2573 50.952 17.7253V24.5685ZM59.6308 27.2882C59.3975 26.8057 59.1277 26.2061 58.8214 25.4897C58.5298 24.7585 58.2236 23.9178 57.9027 22.9673C57.5819 22.0023 57.2538 20.9421 56.9183 19.787C57.0788 19.6115 57.283 19.4654 57.5308 19.3483C57.7788 19.2313 58.0486 19.1729 58.3402 19.1729C58.7194 19.1729 59.0256 19.2606 59.2589 19.4361C59.5069 19.597 59.6964 19.8967 59.8277 20.3353C60.2069 21.4759 60.5861 22.6018 60.9652 23.7131C61.3589 24.8243 61.7745 25.9576 62.212 27.1127H62.2995C62.5767 26.4693 62.8538 25.7164 63.1308 24.8536C63.408 23.9763 63.6705 23.0696 63.9183 22.1339C64.1808 21.1981 64.3995 20.306 64.5745 19.458C64.7495 19.3703 64.9319 19.3045 65.1214 19.2606C65.3111 19.2022 65.5152 19.1729 65.7339 19.1729C66.0986 19.1729 66.412 19.2606 66.6745 19.4361C66.9517 19.597 67.0902 19.8747 67.0902 20.2695C67.0902 20.6205 67.0245 21.0884 66.8933 21.6733C66.7767 22.2435 66.6089 22.8796 66.3902 23.5815C66.1714 24.2833 65.9163 25.0145 65.6245 25.7748C65.3475 26.5351 65.0486 27.2736 64.7277 27.9901C64.4214 28.6919 64.108 29.328 63.787 29.8983C63.0433 31.2288 62.358 32.2306 61.7308 32.9031C61.1038 33.5904 60.4986 33.934 59.9152 33.934C59.4631 33.934 59.0913 33.795 58.7995 33.5173C58.5225 33.2541 58.3549 32.9251 58.2964 32.5303C58.6174 32.2525 58.9527 31.9161 59.3027 31.5213C59.6674 31.1411 60.0174 30.7317 60.3527 30.2931C60.6881 29.8544 60.9725 29.4231 61.2058 28.999C60.958 28.9258 60.71 28.7797 60.462 28.5603C60.2142 28.3264 59.937 27.9023 59.6308 27.2882ZM74.9372 30.0737C75.9434 30.0737 76.833 29.869 77.6059 29.4596C78.3934 29.0355 79.0059 28.4142 79.4434 27.5953C79.8955 26.7764 80.1216 25.7529 80.1216 24.5246C80.1216 23.2525 79.8809 22.2142 79.3997 21.4101C78.933 20.6059 78.2841 20.0209 77.4528 19.6554C76.6216 19.2752 75.6736 19.0851 74.6091 19.0851C73.8216 19.0851 73.1142 19.1802 72.4872 19.3703C71.8602 19.5457 71.3352 19.7577 70.9122 20.0063C70.6059 20.1964 70.3872 20.4011 70.2559 20.6205C70.1247 20.8398 70.0591 21.1176 70.0591 21.4539V28.6481H72.7497V21.7171C72.9684 21.5855 73.2309 21.4759 73.5372 21.3881C73.8434 21.2858 74.2008 21.2346 74.6091 21.2346C75.1341 21.2346 75.608 21.3443 76.0309 21.5636C76.4539 21.7829 76.782 22.1339 77.0153 22.6164C77.2633 23.0844 77.3872 23.7204 77.3872 24.5246C77.3872 25.6797 77.132 26.5351 76.6216 27.0908C76.1111 27.6318 75.4184 27.9023 74.5434 27.9023C74.0184 27.9023 73.5591 27.8146 73.1653 27.6391C72.7861 27.4491 72.458 27.237 72.1809 27.0031V29.328C72.4872 29.518 72.8736 29.6863 73.3403 29.8325C73.8216 29.9934 74.3539 30.0737 74.9372 30.0737ZM72.7497 27.9023L70.0591 27.8804V32.5961C70.0591 33.064 70.1758 33.393 70.4091 33.5831C70.657 33.7731 71.0289 33.8682 71.5247 33.8682C71.7872 33.8682 72.0278 33.8463 72.2466 33.8024C72.4653 33.7731 72.633 33.7366 72.7497 33.6927V27.9023ZM84.7028 25.9503L84.5934 24.064L90.4559 23.1867C90.4122 22.631 90.2008 22.1484 89.8216 21.7391C89.4424 21.3297 88.8883 21.1249 88.1591 21.1249C87.4153 21.1249 86.7955 21.3881 86.2997 21.9145C85.8039 22.4264 85.5486 23.1647 85.5341 24.1298L85.5997 25.2703C85.7309 26.2061 86.0883 26.8934 86.6716 27.3321C87.2695 27.7707 88.0205 27.9901 88.9247 27.9901C89.5372 27.9901 90.1059 27.9023 90.6309 27.7269C91.1559 27.5368 91.5716 27.3321 91.8778 27.1127C92.082 27.2443 92.2423 27.4124 92.3591 27.6172C92.4903 27.8072 92.5559 28.0194 92.5559 28.2533C92.5559 28.6335 92.3883 28.9625 92.0528 29.2403C91.7173 29.5035 91.2653 29.7082 90.6966 29.8544C90.1278 30.0006 89.4789 30.0737 88.7497 30.0737C87.6267 30.0737 86.6278 29.869 85.7528 29.4596C84.8924 29.0355 84.2142 28.4068 83.7184 27.5733C83.2372 26.7399 82.9966 25.7016 82.9966 24.4588C82.9966 23.5669 83.1352 22.7845 83.4122 22.1119C83.6892 21.4394 84.0611 20.8837 84.5278 20.445C85.0091 19.9918 85.5633 19.6554 86.1903 19.4361C86.8174 19.2022 87.4736 19.0851 88.1591 19.0851C89.1216 19.0851 89.9602 19.2825 90.6747 19.6773C91.4039 20.0576 91.9727 20.5912 92.3809 21.2785C92.8039 21.9658 93.0153 22.7554 93.0153 23.6473C93.0153 24.0566 92.9059 24.3637 92.6872 24.5685C92.483 24.7585 92.1914 24.8755 91.8122 24.9194L84.7028 25.9503Z" fill="#ec4c56"/>
      <path d="M10.9375 37.6H18.75" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M26.5625 37.6H71.875" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M79.6875 37.6H87.5" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M10.9375 29.7667H13.2812" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M41.4062 29.7667H43.75" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M20.3125 29.7667H34.375" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M51.5625 12.5333H61.3281" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M70.3125 12.5333H87.5" stroke="#ec4c56" stroke-width="3" stroke-linecap="round"/>
      <path d="M41.0656 14.6889C41.0656 14.2063 41.2116 13.8042 41.5031 13.4825C41.8094 13.1608 42.2105 13 42.7063 13C43.2022 13 43.5959 13.1608 43.8875 13.4825C44.1937 13.8042 44.3469 14.2063 44.3469 14.6889C44.3469 15.1568 44.1937 15.5516 43.8875 15.8733C43.5959 16.1803 43.2022 16.3339 42.7063 16.3339C42.2105 16.3339 41.8094 16.1803 41.5031 15.8733C41.2116 15.5516 41.0656 15.1568 41.0656 14.6889ZM41 21.9707C41 21.5028 41.1459 21.108 41.4375 20.7863C41.7292 20.4647 42.1303 20.3038 42.6406 20.3038C43.1366 20.3038 43.5303 20.4647 43.8219 20.7863C44.1281 21.108 44.2813 21.5028 44.2813 21.9707C44.2813 22.4387 44.1281 22.8335 43.8219 23.1551C43.5303 23.4768 43.1366 23.6377 42.6406 23.6377C42.1303 23.6377 41.7292 23.4768 41.4375 23.1551C41.1459 22.8335 41 22.4387 41 21.9707Z" fill="#ec4c56"/>
      </svg>
    </>
  );
}

const ToolTip = ({ children }: {children: React.ReactNode }) => {
  return (
      <div className={"inline block rounded px-2 py-1 text-bgColor bg-subColor"}>
        {children}
      </div>
  );
}

export default App;